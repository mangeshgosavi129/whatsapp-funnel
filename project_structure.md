## Detailed Project Structure

- **server/**
  - `config.py`
    - *class ServerConfig*
    - *    - def __init__*
  - `database.py`
  - `dependencies.py`
    - *def require_internal_secret*
    - *def get_db*
    - *def get_auth_context*
    - *async def get_ws_auth_context*
  - `enums.py`
    - *class ConversationStage*
    - *class IntentLevel*
    - *class ConversationMode*
    - *class DecisionAction*
    - *class RiskLevel*
    - *class PipelineStep*
    - *class UserSentiment*
    - *class TemplateStatus*
    - *class MessageFrom*
    - *class WSEvents*
  - `main.py`
    - *async def log_requests*
    - *def init_database*
  - `models.py`
    - *class Organization*
    - *class User*
    - *class Conversation*
    - *class Message*
    - *class CTA*
    - *class Template*
    - *class Followup*
    - *class Lead*
    - *class Analytics*
    - *class WhatsAppIntegration*
    - *class AuditLog*
    - *class ConversationEvent*
  - `schemas.py`
    - *class AuthContext*
    - *class AuthTokenOut*
    - *class LoginRequest*
    - *class LoginResponse*
    - *class SignupCreateOrgRequest*
    - *class SignupCreateOrgResponse*
    - *class SignupJoinOrgRequest*
    - *class SignupJoinOrgResponse*
    - *class APIError*
    - *class ErrorResponse*
    - *class SuccessResponse*
    - *class DashboardStatsOut*
    - *class OrganizationOut*
    - *class OrganizationUpdate*
    - *class UserOut*
    - *class UserUpdate*
    - *class ConversationOut*
    - *class ConversationTakeoverOut*
    - *class MessageCreate*
    - *class MessageOut*
    - *class CTACreate*
    - *class CTAUpdate*
    - *class CTAOut*
    - *class TemplateCreate*
    - *class TemplateUpdate*
    - *class TemplateStatusOut*
    - *class TemplateOut*
    - *class FollowupCreate*
    - *class FollowupOut*
    - *class LeadCreate*
    - *class LeadUpdate*
    - *class LeadOut*
    - *class AnalyticsOut*
    - *class AnalyticsReportOut*
    - *class WhatsAppIntegrationCreate*
    - *class WhatsAppIntegrationUpdate*
    - *class WhatsAppIntegrationOut*
    - *class WhatsAppStatusOut*
    - *class WebSocketEnvelope*
    - *class WSConversationUpdated*
    - *class WSTakeoverStarted*
    - *class WSTakeoverEnded*
    - *class WSActionConversationsFlagged*
    - *class WSActionHumanAttentionRequired*
    - *class InternalIntegrationWithOrgOut*
    - *class InternalLeadCreate*
    - *class InternalLeadOut*
    - *class InternalConversationCreate*
    - *class InternalConversationOut*
    - *class InternalConversationUpdate*
    - *class InternalMessageContext*
    - *class InternalIncomingMessageCreate*
    - *class InternalOutgoingMessageCreate*
    - *class InternalMessageOut*
    - *class InternalDueFollowupOut*
    - *class InternalPipelineEventCreate*
    - *class InternalPipelineEventOut*
  - `security.py`
    - *def hash_password*
    - *def verify_password*
    - *def create_access_token*
  - **routes/**
    - `analytics.py`
      - *def get_analytics*
    - `auth.py`
      - *def login*
      - *def signup_create_org*
      - *def signup_join_org*
      - *def get_me*
    - `conversations.py`
      - *def get_conversations*
      - *def update_conversation*
      - *def get_conversation_messages*
      - *def takeover_conversation*
      - *def release_conversation*
    - `ctas.py`
      - *def get_ctas*
      - *def create_cta*
      - *def update_cta*
      - *def delete_cta*
    - `dashboard.py`
      - *def get_dashboard_stats*
    - `debug.py`
      - *async def debug_send_message*
    - `internals.py`
      - *def _integration_to_payload*
      - *def get_whatsapp_integration_by_phone_number_id*
      - *def get_whatsapp_integration_by_organization_id*
      - *def get_integration_with_org*
      - *def get_organization_ctas*
      - *def _lead_to_schema*
      - *def get_lead_by_phone*
      - *def create_lead*
      - *def update_lead*
      - *def _conversation_to_schema*
      - *def get_conversation_by_lead*
      - *async def create_conversation*
      - *def get_due_followups*
      - *def get_conversation*
      - *async def update_conversation*
      - *def get_conversation_messages*
      - *def _message_to_schema*
      - *async def store_incoming_message*
      - *async def store_outgoing_message*
      - *def create_pipeline_event*
      - *async def emit_cta_initiated_event*
      - *async def emit_human_attention_event*
    - `leads.py`
      - *def get_leads*
      - *def create_lead*
      - *def update_lead*
      - *def delete_lead*
    - `messages.py`
      - *def _wa_api_url*
      - *def _wa_text_payload*
      - *def _send_whatsapp_text*
      - *async def send_message_bot*
      - *async def send_message_human*
      - *async def _send_msg*
    - `organisations.py`
      - *def get_organisation*
      - *def update_organisation*
    - `settings.py`
      - *def connect_whatsapp*
      - *def get_whatsapp_status*
      - *def get_whatsapp_config*
      - *def update_whatsapp_config*
      - *def disconnect_whatsapp*
    - `templates.py`
      - *def submit_template_to_meta*
      - *def fetch_template_status_from_meta*
      - *def get_templates*
      - *def create_template*
      - *def update_template*
      - *def delete_template*
      - *def submit_template*
      - *def get_template_status*
    - `users.py`
      - *def get_users*
      - *def get_user*
      - *def update_user*
      - *def delete_user*
    - `websockets.py`
      - *async def websocket_endpoint*
  - **services/**
    - `websocket_events.py`
      - *async def handle_heartbeat*
      - *async def handle_takeover_started*
      - *async def handle_takeover_ended*
      - *async def handle_event*
      - *async def emit_ack*
      - *async def emit_error*
      - *async def emit_conversation_updated*
      - *async def emit_action_conversations_flagged*
      - *async def emit_action_human_attention_required*
      - *async def emit_action_cta_initiated*
    - `websocket_manager.py`
      - *class ConnectionManager*
      - *    - def __init__*
      - *    - def disconnect*
- **llm/**
  - `api_helpers.py`
    - *def extract_json_from_text*
    - *def make_api_call*
  - `config.py`
    - *class LLMConfig*
    - *    - def __init__*
  - `main.py`
  - `pipeline.py`
    - *def run_pipeline*
    - *def _get_emergency_result*
    - *def run_followup_pipeline*
  - `prompts.py`
  - `schemas.py`
    - *class MessageContext*
    - *class TimingContext*
    - *class NudgeContext*
    - *class PipelineInput*
    - *class RiskFlags*
    - *class EyesOutput*
    - *class BrainOutput*
    - *class MouthOutput*
    - *class MemoryOutput*
    - *class PipelineResult*
    - *    - def classification*
    - *    - def response*
    - *    - def summary*
    - *    - def should_send_message*
    - *    - def should_schedule_followup*
    - *    - def should_escalate*
    - *    - def should_initiate_cta*
  - `utils.py`
    - *def normalize_enum*
    - *def format_ctas*
  - **steps/**
    - `brain.py`
      - *def _build_user_prompt*
      - *def _validate_and_build_output*
      - *def run_brain*
    - `eyes.py`
      - *def _format_messages*
      - *def _build_user_prompt*
      - *def _validate_and_build_output*
      - *def run_eyes*
    - `memory.py`
      - *def run_memory*
      - *def _run_memory_llm*
    - `mouth.py`
      - *def _format_messages*
      - *def _build_system_prompt*
      - *def _build_user_prompt*
      - *def _validate_and_build_output*
      - *def run_mouth*
- **whatsapp_worker/**
  - `.DS_Store`
  - `config.py`
    - *class WhatsAppSendConfig*
    - *    - def __init__*
  - `main.py`
    - *def start_worker*
    - *def handle_webhook*
    - *def process_message*
  - `security.py`
    - *def hash_password*
    - *def verify_password*
    - *def create_access_token*
    - *def validate_signature*
  - `tasks.py`
    - *def process_due_followups*
    - *def process_realtime_followup*
  - **processors/**
    - `actions.py`
      - *def handle_pipeline_result*
      - *def log_pipeline_event*
    - `api_client.py`
      - *class InternalsAPIError*
      - *    - def __init__*
      - *class InternalsAPIClient*
      - *    - def __init__*
      - *    - def client*
      - *    - def close*
      - *    - def _handle_response*
      - *    - def get_integration_with_org*
      - *    - def get_organization_ctas*
      - *    - def get_lead_by_phone*
      - *    - def create_lead*
      - *    - def update_lead*
      - *    - def get_or_create_lead*
      - *    - def get_conversation_by_lead*
      - *    - def create_conversation*
      - *    - def get_conversation*
      - *    - def update_conversation*
      - *    - def get_or_create_conversation*
      - *    - def get_conversation_messages*
      - *    - def store_incoming_message*
      - *    - def store_outgoing_message*
      - *    - def send_bot_message*
      - *    - def get_due_followups*
      - *    - def log_pipeline_event*
      - *    - def emit_cta_initiated*
      - *    - def emit_human_attention*
    - `context.py`
      - *def get_last_messages*
      - *def calculate_whatsapp_window*
      - *def build_pipeline_context*
- **whatsapp_receive/**
  - `config.py`
    - *class WhatsAppReceiveConfig*
    - *    - def __init__*
  - `main.py`
    - *async def health*
    - *async def webhook_verify*
    - *async def webhook_receive*
  - `queue.py`
    - *def push_to_queue*
  - `requirements.txt`
  - `security.py`
    - *def verify_webhook*